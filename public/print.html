<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Syncthing Status (Printable)</title>
    <style>
      :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial; color-scheme: light; }
      body { margin: 16px; }
      h1 { margin: 0 0 12px; font-size: 18px; }
      .meta { font-size: 12px; opacity: 0.8; margin-bottom: 8px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { padding: 6px 8px; border: 1px solid #ddd; text-align: left; vertical-align: top; font-size: 12px; }
      th { background: #f5f5f5; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; vertical-align: middle; }
      .dot.green { background: #0a7f2e; }
      .dot.red { background: #b00020; }
      .dot.yellow { background: #f1c40f; }
      .dot.violetgreen { background: linear-gradient(90deg, #8e44ad, #2ecc71); }
      @media print {
        .noprint { display: none !important; }
        body { margin: 6mm; }
      }
    </style>
  </head>
  <body>
    <div class="noprint" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
      <button onclick="window.print()">Print</button>
      <span class="meta" id="updated"></span>
    </div>
    <h1>Syncthing Status</h1>
    <table>
      <thead>
        <tr>
          <th>Node</th>
          <th>Status</th>
          <th>Out-of-sync</th>
          <th>Folders (peer progress)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <script type="module">
      function fmtPct(n){ if(n==null||isNaN(n))return 'â€”%'; return Math.round(Number(n))+'%'; }
      async function load(){
        const res = await fetch('api/nodes');
        const { nodes } = await res.json();
        document.getElementById('updated').textContent = 'Updated: ' + new Date().toLocaleString();
        const tbody = document.getElementById('tbody');
        tbody.innerHTML = '';
        nodes.forEach((n)=>{
          const tr = document.createElement('tr');
          const tdNode = document.createElement('td'); tdNode.textContent = n.name; tr.appendChild(tdNode);
          const tdStatus = document.createElement('td'); tdStatus.textContent = n.ok ? 'OK' : (n.error || 'Down'); tr.appendChild(tdStatus);
          const tdOOS = document.createElement('td'); tdOOS.textContent = String(n.outOfSyncItems ?? 0); tr.appendChild(tdOOS);
          const tdFolders = document.createElement('td');
          const list = document.createElement('div');
          (n.folders||[]).forEach(f=>{
            const line = document.createElement('div');
            const peers = (f.peers||[]).map(p=>{
              const pct = p.items && isFinite(p.items.completionPct) ? Math.round(p.items.completionPct) : null;
              let cls = 'red';
              if (!p.online) cls = 'red';
              else if (f.state && /error/i.test(f.state)) cls = 'yellow';
              else if (pct === 100) cls = 'green';
              else if (f.state==='syncing' || f.state==='scanning') cls = 'violetgreen';
              const pctLabel = p.items && isFinite(p.items.syncedItems) && isFinite(p.items.globalItems)
                ? ` ${p.items.syncedItems}/${p.items.globalItems} (${fmtPct(p.items.completionPct)})` : '';
              return `<span><span class="dot ${cls}"></span><span class="mono">${p.name}${pctLabel}</span></span>`;
            }).join(', ');
            line.innerHTML = `<span class="mono">${f.label}</span>: ${peers}`;
            list.appendChild(line);
          });
          tdFolders.appendChild(list);
          tr.appendChild(tdFolders);
          tbody.appendChild(tr);
        });
      }
      load();
    </script>
  </body>
  </html>


